#!/usr/bin/env ruby

require 'bundler/setup'
require 'porkbun'

PATTERN = /^(?<hostname>[^\s]+)\.\s+(?<ttl>\d+)\s+IN\s+(?<type>[^\s]+)\s*(?<priority>\d+)?\s+(?<content>[^\s]+)$/

def parse_zone_file(file)
  IO.readlines(file).each do |line|
    match_data = line.match(PATTERN)
    next unless match_data

    domain = match_data[:hostname].split('.')[-2..].join('.').chomp '.'
    name = match_data[:hostname].split('.')[-3]

    options = {
      domain:,
      name:,
      ttl: match_data[:ttl],
      type: match_data[:type],
      prio: match_data[:priority],
      content: match_data[:content].chomp('.')
    }.compact
    next if match_data[:type] == 'MX'

    record = Porkbun::DNS.create options
    pp record
  end
end

parse_zone_file ARGV[0]
